# Домашнее задание к занятию 15.2 "Вычислительные мощности. Балансировщики нагрузки".
Домашнее задание будет состоять из обязательной части, которую необходимо выполнить на провайдере Яндекс.Облако, и дополнительной части в AWS (можно выполнить по желанию). Все домашние задания в 15 блоке связаны друг с другом и в конце представляют пример законченной инфраструктуры.
Все задания требуется выполнить с помощью Terraform, результатом выполненного домашнего задания будет код в репозитории. Перед началом работ следует настроить доступ до облачных ресурсов из Terraform, используя материалы прошлых лекций и ДЗ.

---
## Задание 1. Яндекс.Облако (обязательное к выполнению)

1. Создать bucket Object Storage и разместить там файл с картинкой:
- Создать bucket в Object Storage с произвольным именем (например, _имя_студента_дата_);
- Положить в bucket файл с картинкой;  
```
 key    = "shepherd.jpg"
```
![shepherd](https://user-images.githubusercontent.com/30965391/160254034-90ec9592-66f2-48fb-8350-07e88eec846d.jpg)

- Сделать файл доступным из Интернет.  
![image](https://user-images.githubusercontent.com/30965391/160257130-c64fac8a-586c-44e7-abc5-bf391db05cf0.png)

2. Создать группу ВМ в public подсети фиксированного размера с шаблоном LAMP и web-страничкой, содержащей ссылку на картинку из bucket:
- Создать Instance Group с 3 ВМ и шаблоном LAMP. Для LAMP рекомендуется использовать `image_id = fd827b91d99psvq5fjit`;
- Для создания стартовой веб-страницы рекомендуется использовать раздел `user_data` в [meta_data](https://cloud.yandex.ru/docs/compute/concepts/vm-metadata);
- Разместить в стартовой веб-странице шаблонной ВМ ссылку на картинку из bucket;
- Настроить проверку состояния ВМ.

3. Подключить группу к сетевому балансировщику:  
- Создать сетевой балансировщик;  
![image](https://user-images.githubusercontent.com/30965391/160253724-7f5d83ed-6fc6-4c6d-9a81-ffc8279a3baf.png)  

![image](https://user-images.githubusercontent.com/30965391/160253714-ceb6053e-1157-4a06-92e0-36d67eb6a04f.png)

- Проверить работоспособность, удалив одну или несколько ВМ.  
![image](https://user-images.githubusercontent.com/30965391/160253775-1aa0291c-effb-4702-9c79-c9b6546bb8b7.png)
![image](https://user-images.githubusercontent.com/30965391/160253798-68e326bb-de48-4aad-a8c4-8e613a38acbf.png)

4. *Создать Application Load Balancer с использованием Instance group и проверкой состояния.  
# Доработка
* Получилось *
![image](https://user-images.githubusercontent.com/30965391/162035966-3263be91-8b22-43c1-96d6-93045da71279.png)
ALP-healthcheck красил группу тачек в грасный, из-за этого не работало тоже.
Убрал хелзчек:
```
healthcheck {  
      timeout = "3s"  
      interval = "10s"  
      http_healthcheck {  
        path  = "/"  
          
      }  
```
      заработало.  
      причины - не ясны  
      ![image](https://user-images.githubusercontent.com/30965391/162037465-1b4d67ec-81a6-441e-a33e-778dc5804d06.png)  
  
вот видно, что инстансы заатачены 
![image](https://user-images.githubusercontent.com/30965391/162037632-ebb36276-034e-41b5-a749-48b4136ab71c.png)  

Рабочий terraform файл, нужно только секреты подставить свои
```
terraform {
  required_providers {
    yandex = {
      source = "terraform-registry.storage.yandexcloud.net/yandex-cloud/yandex"
    }
  }
  required_version = ">= 0.13"
}

provider "yandex" {
  token     = "секрет"
  cloud_id  = "cloud-lyambdazondgmailcom"
  folder_id = "b1g1e417rlclna6nbfk6"
  zone      = "ru-central1-b"

}



resource "yandex_storage_object" "test-object" {
  access_key = "секрет" # Идентификатор статического ключа доступа.
  secret_key = "секрет" # Значение секретного ключа доступа.
  bucket = "nik25032022" # Имя бакета для добавления объекта. Обязательный параметр.
  key    = "shepherd.jpg" # Имя объекта в бакете. Обязательный параметр.
  source = "shepherd.jpg" # Относительный или абсолютный путь к файлу, загружаемому как объект.
}

resource "yandex_iam_service_account" "ig-sa" {
  name        = "ig-sa"
  description = "service account to manage IG"

}

resource "yandex_resourcemanager_folder_iam_binding" "editor" {
  folder_id = "b1g1e417rlclna6nbfk6"
  role      = "editor"
  members   = [
    "serviceAccount:${yandex_iam_service_account.ig-sa.id}",
  ]
  depends_on = [
    yandex_iam_service_account.ig-sa,
  ]
}

resource "yandex_compute_instance_group" "ig-1" {

  name               = "fixed-ig"
  folder_id          = "b1g1e417rlclna6nbfk6"
  service_account_id = "${yandex_iam_service_account.ig-sa.id}"
  depends_on          = [yandex_resourcemanager_folder_iam_binding.editor]
      instance_template {

        platform_id = "standard-v2"
        resources {
          memory = 1
          cores  = 2
          core_fraction = 20
         }

        boot_disk {
          mode = "READ_WRITE"
          initialize_params {
            image_id = "fd827b91d99psvq5fjit"
          }
        }

        network_interface {
          network_id = "${yandex_vpc_network.test_network.id}"
          subnet_ids = ["${yandex_vpc_subnet.public.id}"]
          #nat = "true"
        }

        metadata = {
              user-data = "${file("config.yaml")}"
              ssh-keys = "yc-user:${file("pubkey.pem.pub")}"
            }
        scheduling_policy {
          preemptible = true
        }
      }


  timeouts {
    create = "10m"
  }
  scale_policy {
    fixed_scale {
      size = 3
    }
  }

  allocation_policy {
    zones = ["ru-central1-b"]
  }

  deploy_policy {
    max_unavailable = 1
    max_expansion = 0
  }
  application_load_balancer {
    target_group_name        = "target-group"
    target_group_description = "load balancer target group"
  }
}
data "yandex_compute_instance_group" "ig-1" {
 instance_group_id = "some_instance_group_id"
}


resource "yandex_vpc_network" "test_network" {}

resource "yandex_vpc_subnet" "public" {
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.test_network.id
  v4_cidr_blocks = ["192.168.10.0/24"]
  name               = "public"
}

resource "yandex_lb_target_group" "group2" {
  name      = "my-target-group"

  target {
    subnet_id = "${yandex_vpc_subnet.public.id}"
    address   = "${yandex_compute_instance_group.ig-1.instances.0.network_interface.0.ip_address}"
  }
  target {
      subnet_id = "${yandex_vpc_subnet.public.id}"
      address   = "${yandex_compute_instance_group.ig-1.instances.1.network_interface.0.ip_address}"
    }
  target {
      subnet_id = "${yandex_vpc_subnet.public.id}"
      address   = "${yandex_compute_instance_group.ig-1.instances.2.network_interface.0.ip_address}"
    }

}


resource "yandex_lb_network_load_balancer" "foo" {
  name = "my-network-load-balancer"

  listener {
    name = "my-listener"
    port = 80
    external_address_spec {
      ip_version = "ipv4"
    }
  }

  attached_target_group {
    target_group_id = "${yandex_lb_target_group.group2.id}"

    healthcheck {
      name = "http"
      http_options {
        port = 80
        path = "/index.html"
      }
    }
  }
}


resource "yandex_vpc_security_group" "appb-sg-vm" {
  name       = "canary-sg"
  network_id = "${yandex_vpc_network.test_network.id}"

  ingress {
    protocol       = "TCP"
    port           = 80
    v4_cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    protocol       = "TCP"
    port           = 443
    v4_cidr_blocks = ["0.0.0.0/0"]
  }
  egress {
    protocol       = "Any"
    from_port      = 0
    to_port        = 65535
    v4_cidr_blocks = ["0.0.0.0/0"]
  }


}

resource "yandex_alb_target_group" "alb-tg" {
     name      = "alb-target-group"

    target {
      subnet_id = "${yandex_vpc_subnet.public.id}"
      ip_address   = "${yandex_compute_instance_group.ig-1.instances.0.network_interface.0.ip_address}"
    }

    target {
      subnet_id = "${yandex_vpc_subnet.public.id}"
      ip_address   = "${yandex_compute_instance_group.ig-1.instances.1.network_interface.0.ip_address}"
    }

    target {
      subnet_id = "${yandex_vpc_subnet.public.id}"
      ip_address   = "${yandex_compute_instance_group.ig-1.instances.2.network_interface.0.ip_address}"
    }
}
resource "yandex_alb_backend_group" "test-backend-group" {
  name      = "my-backend-group"

  http_backend {
    name = "test-http-backend"
    #weight = 1
    port = 80
    target_group_ids = ["${yandex_alb_target_group.alb-tg.id}"]

    load_balancing_config {
      panic_threshold = 50
    }


  }
}
resource "yandex_alb_http_router" "tf-router" {
  name      = "my-http-router"

}
resource "yandex_alb_virtual_host" "my-virtual-host" {
  name      = "my-virtual-host"
  http_router_id = yandex_alb_http_router.tf-router.id
  route {
    name = "my-route"
    http_route {
      http_route_action {
        backend_group_id = yandex_alb_backend_group.test-backend-group.id
        timeout = "3s"
      }
    }
  }
}
resource "yandex_alb_load_balancer" "test-balancer" {
  name        = "my-load-balancer"

  network_id  = "${yandex_vpc_network.test_network.id}"

  allocation_policy {
    location {
      zone_id   = "ru-central1-b"
      subnet_id = yandex_vpc_subnet.public.id
    }
  }

  listener {
    name = "my-listener"
    endpoint {
      address {
        external_ipv4_address {
        }
      }
      ports = [ 80 ]
    }
    http {
      handler {
        http_router_id = "${yandex_alb_http_router.tf-router.id}"
      }
    }
  }
}


```
Документация
- [Compute instance group](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/compute_instance_group)
- [Network Load Balancer](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/lb_network_load_balancer)
- [Группа ВМ с сетевым балансировщиком](https://cloud.yandex.ru/docs/compute/operations/instance-groups/create-with-balancer)
---
## Задание 2*. AWS (необязательное к выполнению)

Используя конфигурации, выполненные в рамках ДЗ на предыдущем занятии, добавить к Production like сети Autoscaling group из 3 EC2-инстансов с  автоматической установкой web-сервера в private домен.

1. Создать bucket S3 и разместить там файл с картинкой:
- Создать bucket в S3 с произвольным именем (например, _имя_студента_дата_);
- Положить в bucket файл с картинкой;
- Сделать доступным из Интернета.
2. Сделать Launch configurations с использованием bootstrap скрипта с созданием веб-странички на которой будет ссылка на картинку в S3. 
3. Загрузить 3 ЕС2-инстанса и настроить LB с помощью Autoscaling Group.

Resource terraform
- [S3 bucket](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket)
- [Launch Template](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template)
- [Autoscaling group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group)
- [Launch configuration](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_configuration)

Пример bootstrap-скрипта:
```
#!/bin/bash
yum install httpd -y
service httpd start
chkconfig httpd on
cd /var/www/html
echo "<html><h1>My cool web-server</h1></html>" > index.html
```
